name: Build & Release APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_API: 31
      ANDROID_BUILD_TOOLS: 31.0.0
      ANDROID_NDK_VERSION: 23b
      # استخدم المتغير البيئي RUNNER_TOOL_CACHE بدلاً من runner.tool_cache
      ANDROID_SDK_ROOT: ${{ env.RUNNER_TOOL_CACHE }}/android-sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('buildozer.spec') }}

      - name: Cache Android SDK
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools
            ${{ env.ANDROID_SDK_ROOT }}/platforms
            ${{ env.ANDROID_SDK_ROOT }}/build-tools
          key: ${{ runner.os }}-android-sdk-${{ env.ANDROID_API }}-${{ env.ANDROID_BUILD_TOOLS }}-${{ env.ANDROID_NDK_VERSION }}

      - name: Set up Java (for Android SDK tools)
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-setuptools \
            git unzip zip openjdk-11-jdk \
            libgl1-mesa-dev libgles2-mesa \
            libopencv-dev

      - name: Install Buildozer & python-for-android
        run: |
          python3 -m pip install --upgrade pip
          pip install --upgrade buildozer Cython
          pip install git+https://github.com/kivy/python-for-android.git@develop

      - name: Install Android SDK & NDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT
          cd $ANDROID_SDK_ROOT
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip
          mkdir -p cmdline-tools/latest
          mv tools/* cmdline-tools/latest/
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;${ANDROID_BUILD_TOOLS}" \
            "ndk;${ANDROID_NDK_VERSION}"

      - name: Build APK (debug)
        run: buildozer -v android debug
        working-directory: .

      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: CaptchaApp-debug-apk
          path: bin/*.apk
